// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.28.0
// source: site_views.sql

package db

import (
	"context"
	"database/sql"

	"github.com/jackc/pgx/v5/pgtype"
)

const insertSiteView = `-- name: InsertSiteView :exec
INSERT INTO site_views (
    session_id,
    visitor_id,
    created_at,
    url_path,
    url_query,
    referrer_path,
    referrer_query,
    referrer_domain,
    page_title,
    event_type,
    event_name
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
)
`

type InsertSiteViewParams struct {
	SessionID      pgtype.UUID
	VisitorID      pgtype.UUID
	CreatedAt      pgtype.Timestamptz
	UrlPath        sql.NullString
	UrlQuery       sql.NullString
	ReferrerPath   sql.NullString
	ReferrerQuery  sql.NullString
	ReferrerDomain sql.NullString
	PageTitle      sql.NullString
	EventType      NullSiteEvent
	EventName      sql.NullString
}

func (q *Queries) InsertSiteView(ctx context.Context, db DBTX, arg InsertSiteViewParams) error {
	_, err := db.Exec(ctx, insertSiteView,
		arg.SessionID,
		arg.VisitorID,
		arg.CreatedAt,
		arg.UrlPath,
		arg.UrlQuery,
		arg.ReferrerPath,
		arg.ReferrerQuery,
		arg.ReferrerDomain,
		arg.PageTitle,
		arg.EventType,
		arg.EventName,
	)
	return err
}

const queryTrafficCountsByDate = `-- name: QueryTrafficCountsByDate :many
select 
	date_trunc('hour', created_at)::timestamp AS hour,
	count(distinct visitor_id) as visitor_count,
	count(id) as views
from 
	site_views 
where 
    created_at >= $1::timestamp
	AND created_at <= $2::timestamp
    AND event_type = 'page_view'
group by date_trunc('hour', created_at)
`

type QueryTrafficCountsByDateParams struct {
	StartDate pgtype.Timestamp
	EndDate   pgtype.Timestamp
}

type QueryTrafficCountsByDateRow struct {
	Hour         pgtype.Timestamp
	VisitorCount int64
	Views        int64
}

func (q *Queries) QueryTrafficCountsByDate(ctx context.Context, db DBTX, arg QueryTrafficCountsByDateParams) ([]QueryTrafficCountsByDateRow, error) {
	rows, err := db.Query(ctx, queryTrafficCountsByDate, arg.StartDate, arg.EndDate)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []QueryTrafficCountsByDateRow
	for rows.Next() {
		var i QueryTrafficCountsByDateRow
		if err := rows.Scan(&i.Hour, &i.VisitorCount, &i.Views); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const queryViewsByDate = `-- name: QueryViewsByDate :many
SELECT 
    site_views.id, site_views.session_id, site_views.visitor_id, site_views.created_at, site_views.url_path, site_views.url_query, site_views.referrer_path, site_views.referrer_query, site_views.referrer_domain, site_views.page_title, site_views.event_type, site_views.event_name,
	site_sessions.id, site_sessions.created_at, site_sessions.hostname, site_sessions.browser, site_sessions.os, site_sessions.device, site_sessions.screen, site_sessions.lang, site_sessions.country, site_sessions.subdivision1, site_sessions.subdivision2, site_sessions.city, site_sessions.finger
FROM site_views
JOIN site_sessions on 
	site_sessions.id=site_views.session_id
WHERE 
    site_views.created_at >= $1::timestamp
	AND site_views.created_at <= $2::timestamp
    AND event_type = 'page_view'
`

type QueryViewsByDateParams struct {
	StartDate pgtype.Timestamp
	EndDate   pgtype.Timestamp
}

type QueryViewsByDateRow struct {
	SiteView    SiteView
	SiteSession SiteSession
}

func (q *Queries) QueryViewsByDate(ctx context.Context, db DBTX, arg QueryViewsByDateParams) ([]QueryViewsByDateRow, error) {
	rows, err := db.Query(ctx, queryViewsByDate, arg.StartDate, arg.EndDate)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []QueryViewsByDateRow
	for rows.Next() {
		var i QueryViewsByDateRow
		if err := rows.Scan(
			&i.SiteView.ID,
			&i.SiteView.SessionID,
			&i.SiteView.VisitorID,
			&i.SiteView.CreatedAt,
			&i.SiteView.UrlPath,
			&i.SiteView.UrlQuery,
			&i.SiteView.ReferrerPath,
			&i.SiteView.ReferrerQuery,
			&i.SiteView.ReferrerDomain,
			&i.SiteView.PageTitle,
			&i.SiteView.EventType,
			&i.SiteView.EventName,
			&i.SiteSession.ID,
			&i.SiteSession.CreatedAt,
			&i.SiteSession.Hostname,
			&i.SiteSession.Browser,
			&i.SiteSession.Os,
			&i.SiteSession.Device,
			&i.SiteSession.Screen,
			&i.SiteSession.Lang,
			&i.SiteSession.Country,
			&i.SiteSession.Subdivision1,
			&i.SiteSession.Subdivision2,
			&i.SiteSession.City,
			&i.SiteSession.Finger,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
